#cloud-config
# vim: syntax=yaml
disable_root: false
{% if ROOT_SSH_PUBKEY|length > 1 %}
ssh_authorized_keys:
  - {{ROOT_SSH_PUBKEY}}
{% endif %}
{% if APPLIANCE_PASSWORD|length > 1 %}
ssh_pwauth: True
chpasswd:
  list: |
    root:{{ APPLIANCE_PASSWORD }}
  expire: False
{% endif %}
{% if TIME_ZONE is defined %}
timezone: {{ TIME_ZONE }}
{% endif %}
bootcmd:
  - setenforce 0
  - if grep -Gq "^\s*PermitRootLogin" /etc/ssh/sshd_config; then sed -re "s/^\s*(PermitRootLogin)\s+(yes|no|without-password)/ \1 {{ ROOT_SSH_ACCESS }}/" -i.$(date -u +%Y%m%d%H%M%S) /etc/ssh/sshd_config; else echo "PermitRootLogin {{ ROOT_SSH_ACCESS }}" >> /etc/ssh/sshd_config; fi
  - sed -i 's/127\.0\.0\.1[ ]*localhost localhost.localdomain localhost4 localhost4.localdomain4$/127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 {{ FQDN }}/g' /etc/hosts
{% if VM_ETC_HOSTS %}
  - echo "{{ HOST_IP }} {{ HOST_ADDRESS }}" >> /etc/hosts
{% endif %}
write_files:
  - content: |
      [environment:init]
      DIALOG/autoAcceptDefault=bool:True
      [environment:default]
      OVESETUP_CONFIG/adminPassword=str:{{ ADMIN_PASSWORD}}
      OVESETUP_CONFIG/fqdn=str:{{ FQDN }}
      OVESETUP_PKI/organization=str:{{ CLOUD_INIT_DOMAIN_NAME }}
    path: /root/heanswers.conf
    owner: root:root
    permissions: '0640'
runcmd:
  - systemctl restart sshd &
  - /usr/bin/engine-setup --offline --config-append=/root/ovirt-engine-answers --config-append=/root/heanswers.conf {% if ENABLE_LIBGFAPI %} && engine-config -s LibgfApiSupported=true --cver=4.1 && engine-config -s LibgfApiSupported=true --cver=4.2 && systemctl restart ovirt-engine {% endif %} ;
  - rm /root/heanswers.conf
  - systemctl mask cloud-init-local
  - systemctl mask cloud-init
  - setenforce 1